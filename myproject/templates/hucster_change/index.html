{% load static %}
<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>Hucster • Панель управления</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        :root{
            --bg:#0b1220;--card:#121a2b;--border:#1f2a44;--text:#e8eefc;
            --muted:#9bb0d3;--accent:#3656d8;--success:#24d87a;--danger:#d83c3c;
        }
        body{background:var(--bg);color:var(--text);}
        .container-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px;}
        .btn-accent{background:var(--accent);color:#fff}
        .json-output{
            background:#0d162c;border-radius:12px;padding:16px;white-space:pre-wrap;
            font-family:monospace;font-size:14px;color:#cde3ff;max-height:400px;overflow:auto;
        }
        textarea{background:#0d162c;color:#fff;border:1px solid var(--border);}
    </style>

</head>
<body>

<div class="container py-5">

    <h1 class="mb-3">Hucster • Панель управления</h1>
    <p class="text-secondary">Отправка запросов в Huckster по артикулам.</p>

    <div class="row g-4">

        <!-- КАРТОЧКА 1: Все артикулы OZON -->
        <div class="col-md-6">
            <div class="container-card">
                <h4>Отправить все артикулы • OZON</h4>
                <p class="text-danger fw-bold">ЗАПУСКАТЬ В КРАЙНЕМ СЛУЧАЕ! Перегружает сервер Huckster</p>
                <button class="btn btn-accent w-100" onclick="runAll('ozon')">Запустить OZON</button>
            </div>
        </div>

        <!-- КАРТОЧКА 2: Все артикулы WB -->
        <div class="col-md-6">
            <div class="container-card">
                <h4>Отправить все артикулы • Wildberries</h4>
                <p class="text-danger fw-bold">ЗАПУСКАТЬ В КРАЙНЕМ СЛУЧАЕ! Перегружает сервер Huckster</p>
                <button class="btn btn-accent w-100" onclick="runAll('wb')">Запустить WB</button>
            </div>
        </div>

        <!-- КАРТОЧКА 3: Ручной ввод -->
        <div class="col-12">
            <div class="container-card">
                <h4>Отправка выбранных артикулов</h4>

                <form id="manualForm" onsubmit="sendSelected(event)" method="post">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label class="form-label">Введите артикулы (через ENTER):</label>
                        <textarea name="keys" id="keys" rows="3" class="form-control"
                                  placeholder="ColdBTX150"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Маркетплейс:</label>
                        <select name="mp" id="mp" class="form-select">
                            <option value="ozon">OZON</option>
                            <option value="wb">Wildberries</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-accent w-100">Отправить</button>
                </form>
            </div>
        </div>

        <!-- КАРТОЧКА 4: Результаты -->
        <div class="col-12">
            <div class="container-card">
                <h4>Результаты работы</h4>
                <div id="result" class="json-output">Ожидание...</div>
            </div>
        </div>

    </div>

</div>


<!-- Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    function getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }

    function runAll(mp) {
        document.getElementById("result").innerText = "Выполняется запрос...";
        fetch(`/hucster/run-all/${mp}/`)
            .then(r => r.json())
            .then(data => {
                document.getElementById("result").innerText =
                    JSON.stringify(data, null, 4);
            });
    }

    function sendSelected(event) {
        event.preventDefault();
        const formData = new FormData(document.getElementById("manualForm"));

        document.getElementById("result").innerText = "Выполняется запрос...";

        fetch("/hucster/run-selected/", {
            method: "POST",
            headers: {"X-CSRFToken": getCSRFToken()},
            body: formData
        })
        .then(r => r.json())
        .then(data => {
            document.getElementById("result").innerText =
                JSON.stringify(data, null, 4);
        });
    }
</script>

</body>
</html>
